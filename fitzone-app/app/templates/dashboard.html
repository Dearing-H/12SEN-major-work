<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üèãÔ∏è FITZONE Dashboard</title>

  <style>
    :root {
      --bg: #0f0f0f;
      --card: #1e1e1e;
      --accent: #00e0ff;
      --text: #ffffff;
      --hover: #00bcd4;
      --nav-bg: #161616;
      --active: #00ff99;
    }

    body.light-mode {
      --bg: #ffffff;
      --card: #f4f4f4;
      --accent: #0077cc;
      --text: #000000;
      --hover: #005fa3;
      --nav-bg: #e0e0e0;
      --active: #44c767;
    }
    .theme-toggle {
      position: fixed;
      top: 12px;
      right: 12px;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background-color: var(--card);
      border: 2px solid var(--accent);
      color: var(--accent);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      box-shadow: 0 0 5px var(--accent);
      transition: background-color 0.3s ease;
    }

    .theme-toggle:hover {
      background-color: var(--accent);
      color: var(--bg);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Orbitron', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--nav-bg), var(--card));
      padding: 20px;
      text-align: center;
      border-bottom: 2px solid var(--accent);
      box-shadow: 0 4px 20px rgba(0,224,255,0.3);
    }

    .header h1 {
      color: var(--accent);
      margin-bottom: 20px;
      font-size: 2.5rem;
      text-shadow: 0 0 20px rgba(0,224,255,0.5);
    }

    .nav-menu {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      padding: 10px 0;
    }

    .nav-item {
      background: var(--card);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 120px;
      position: relative;
      overflow: hidden;
    }

    .nav-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0,224,255,0.2), transparent);
      transition: left 0.5s;
    }

    .nav-item:hover::before {
      left: 100%;
    }

    .nav-item:hover {
      border-color: var(--accent);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,224,255,0.4);
    }

    .nav-item.active {
      border-color: var(--active);
      background: linear-gradient(135deg, var(--card), rgba(0,255,153,0.1));
      box-shadow: 0 8px 25px rgba(0,255,153,0.3);
    }

    .nav-icon {
      font-size: 2rem;
      color: var(--accent);
      transition: color 0.3s ease;
    }

    .nav-item.active .nav-icon {
      color: var(--active);
    }

    .nav-label {
      font-size: 0.9rem;
      font-weight: bold;
      text-align: center;
    }

    .main-container {
      padding: 30px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .quick-stats {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--card);
      flex: 1;
      min-width: 180px;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,224,255,0.15);
      font-weight: bold;
      text-align: center;
      color: var(--accent);
    }
    .motivational-quote {
      margin-top: 20px;
      font-size: 1.2rem;
      color: #00ff99;
      font-style: italic;
      text-align: center;
    }

    .content-frame {
      background: var(--card);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 0 30px rgba(0,224,255,0.2);
      border: 1px solid rgba(0,224,255,0.3);
      min-height: 500px;
      position: relative;
      overflow: hidden;
    }

    .content-frame::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--active), var(--accent));
      border-radius: 16px 16px 0 0;
    }

    .section {
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      margin-bottom: 1.5rem;
      color: var(--accent);
      font-size: 1.8rem;
      text-align: center;
      text-shadow: 0 0 10px rgba(0,224,255,0.5);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text);
      font-weight: bold;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px;
      background: #2b2b2b;
      border: 2px solid transparent;
      border-radius: 8px;
      color: var(--text);
      font-size: 1rem;
      transition: border-color 0.3s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.10);
    }
    input:hover, textarea:hover, select:hover {
      box-shadow: 0 0 8px rgba(0,224,255,0.2);
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 10px rgba(0,224,255,0.3);
    }

    button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, var(--accent), var(--hover));
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      color: #000;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 1rem;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,224,255,0.4);
    }

    .result {
      margin-top: 1rem;
      padding: 15px;
      background: rgba(0,224,255,0.1);
      border-radius: 8px;
      border-left: 4px solid var(--accent);
      font-weight: bold;
      font-size: 1.1rem;
    }

    ul {
      list-style: none;
      margin-top: 1rem;
    }

    ul li {
      background: rgba(0,255,153,0.1);
      margin: 8px 0;
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid var(--active);
    }

    canvas {
      background: #111;
      border-radius: 8px;
      width: 100%;
      margin-top: 1rem;
    }

    #tooltip {
      position: fixed;
      background: rgba(0, 0, 0, 0.9);
      color: var(--active);
      padding: 8px 12px;
      border-radius: 6px;
      pointer-events: none;
      font-family: monospace;
      font-size: 0.9rem;
      transition: opacity 0.3s;
      z-index: 1000;
      border: 1px solid var(--active);
    }

    .welcome-section {
      text-align: center;
      padding: 40px 20px;
    }

    .welcome-section h2 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      background: linear-gradient(135deg, var(--accent), var(--active));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .welcome-section p {
      font-size: 1.2rem;
      opacity: 0.8;
      line-height: 1.6;
    }

    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-top: 1rem;
    }

    @media (max-width: 768px) {
      .nav-menu {
        gap: 10px;
      }
      
      .nav-item {
        min-width: 100px;
        padding: 12px 15px;
      }
      
      .nav-icon {
        font-size: 1.5rem;
      }
      
      .nav-label {
        font-size: 0.8rem;
      }

      .two-column {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/konva@9.3.13/konva.min.js"></script>
</head>
<body>
  <button onclick="toggleTheme()" class="theme-toggle" title="Toggle theme">üåó</button>
  <header class="header" style="position: relative;">
    <h1 style="font-size: 2.75rem; color: var(--accent); text-shadow: 0 0 12px var(--accent);">üèãÔ∏è FITZONE</h1>
    <nav class="nav-menu">
      <div class="nav-item active" onclick="showSection('welcome')">
        <div class="nav-icon">üè†</div>
        <div class="nav-label">Home</div>
      </div>
      <div class="nav-item" onclick="showSection('bmi')">
        <div class="nav-icon">‚öñÔ∏è</div>
        <div class="nav-label">BMI</div>
      </div>
      <div class="nav-item" onclick="showSection('calories')">
        <div class="nav-icon">üî•</div>
        <div class="nav-label">Calories</div>
      </div>
      <div class="nav-item" onclick="showSection('reps')">
        <div class="nav-icon">üí™</div>
        <div class="nav-label">Rep Tracker</div>
      </div>
      <div class="nav-item" onclick="showSection('meals')">
        <div class="nav-icon">üçΩÔ∏è</div>
        <div class="nav-label">Meals</div>
      </div>
      <div class="nav-item" onclick="showSection('goals')">
        <div class="nav-icon">üéØ</div>
        <div class="nav-label">Goals</div>
      </div>
      <div class="nav-item" onclick="showSection('workout')">
        <div class="nav-icon">üìÖ</div>
        <div class="nav-label">Workout</div>
      </div>
      <div class="nav-item" onclick="showSection('water')">
        <div class="nav-icon">üíß</div>
        <div class="nav-label">Water</div>
      </div>
      <div class="nav-item" onclick="showSection('progress')">
        <div class="nav-icon">üìä</div>
        <div class="nav-label">Progress</div>
      </div>
      <!-- About nav item -->
      <div class="nav-item" onclick="showSection('about')">
        <div class="nav-icon">‚ÑπÔ∏è</div>
        <div class="nav-label">About</div>
      </div>
      <!-- Logout button -->
      <div class="nav-item" onclick="window.location.href='{{ url_for('logout') }}'">
        <div class="nav-icon">üö™</div>
        <div class="nav-label">Logout</div>
      </div>
    </nav>
  </header>

  <main class="main-container">
    <div class="quick-stats">
      <div class="stat-card">üë§ User: <strong>{{ user.username }}</strong></div>
      <div class="stat-card">‚öñÔ∏è BMI: <strong>{{ user.bmi or 'N/A' }}</strong></div>
      <div class="stat-card">üî• TDEE: <strong>{{ user.tdee or 'N/A' }} kcal</strong></div>
      <div class="stat-card">üéØ Goal: <strong>{{ user.goal_weight or 'N/A' }} kg</strong></div>
    </div>
    <div class="content-frame">
      <!-- Welcome Section -->
      <section id="welcome" class="section active">
        <div class="welcome-section">
          <h2>Welcome to FITZONE</h2>
          <p>Your ultimate fitness companion! Select any tool from the menu above to track your progress, plan your workouts, and achieve your fitness goals.</p>
          <p>Get started by clicking on one of the icons above to access different features.</p>
        </div>
        <div class="motivational-quote">
          ‚ÄúDon‚Äôt count the days. Make the days count.‚Äù ‚Äì Muhammad Ali
        </div>
      </section>

      <!-- BMI Section -->
      <section id="bmi" class="section">
        <h2>BMI Checker</h2>
        <div class="two-column">
          <div>
            <form id="bmi-form" method="post">
              <div class="form-group">
                <label for="weight">Weight (kg):</label>
                <input type="number" step="0.1" id="weight" name="weight" value="{{ user.weight or '' }}" required placeholder="e.g., 70.5" aria-label="Weight in kilograms" />
                <small>Use decimal format (e.g., 70.5)</small>
              </div>
              <div class="form-group">
                <label for="height">Height (cm):</label>
                <input type="number" step="0.1" id="height" name="height" value="{{ user.height or '' }}" required placeholder="e.g., 175.0" aria-label="Height in centimeters" />
                <small>Use decimal format (e.g., 175.0)</small>
              </div>
              <button type="submit" name="bmi_submit">Save &amp; Calculate BMI ‚ûï</button>
            </form>
            <button onclick="calculateBMI()">Calculate BMI ‚ûï</button>
          </div>
          <div>
            <div id="bmi-result" class="result" style="margin-top: 1rem;">
              {% if user.bmi %}
                Your last saved BMI is <strong>{{ user.bmi }}</strong>.
              {% else %}
                Enter your details to calculate BMI.
              {% endif %}
            </div>
          </div>
        </div>
      </section>

      <!-- Calories Section -->
      <section id="calories" class="section">
        <h2>Daily Calorie Calculator</h2>
        <div class="two-column">
          <div>
            <form method="POST">
              <div class="form-group">
                <label for="cal-age">Age</label>
                <input type="number" id="cal-age" name="age" value="{{ user.age or '' }}" placeholder="Enter your age" min="0" required aria-label="Age in years" />
              </div>
              <div class="form-group">
                <label for="cal-weight">Weight (kg)</label>
                <input type="number" id="cal-weight" name="c_weight" value="{{ user.weight or '' }}" placeholder="e.g., 70.5" min="0" step="0.1" required aria-label="Weight in kilograms" />
                <small>Use decimal format (e.g., 70.5)</small>
              </div>
              <div class="form-group">
                <label for="cal-height">Height (cm)</label>
                <input type="number" id="cal-height" name="c_height" value="{{ user.height or '' }}" placeholder="e.g., 175.0" min="0" step="0.1" required aria-label="Height in centimeters" />
                <small>Use decimal format (e.g., 175.0)</small>
              </div>
              <div class="form-group">
                <label for="cal-activity">Activity Level</label>
                <select id="cal-activity" name="activity" required aria-label="Activity Level">
                  <option value="1.2" {% if user.activity_level == 1.2 %}selected{% endif %}>Sedentary</option>
                  <option value="1.375" {% if user.activity_level == 1.375 %}selected{% endif %}>Lightly active</option>
                  <option value="1.55" {% if user.activity_level == 1.55 %}selected{% endif %}>Moderately active</option>
                  <option value="1.725" {% if user.activity_level == 1.725 %}selected{% endif %}>Very active</option>
                  <option value="1.9" {% if user.activity_level == 1.9 %}selected{% endif %}>Extra active</option>
                </select>
                <small>Select based on your average daily activity</small>
              </div>
              <button type="submit" name="calorie_submit">Save Calories üçΩÔ∏è</button>
            </form>
            <button onclick="calculateCalories()">Calculate TDEE üî•</button>
          </div>
          <div>
            <div class="result" id="cal-result" style="margin-top: 1rem;">
              {% if user.tdee %}
                Your last calculated daily requirement is <strong>{{ user.tdee }} kcal</strong>.
              {% else %}
                Enter your details to calculate daily calories.
              {% endif %}
            </div>
          </div>
        </div>
      </section>

      <!-- Rep Tracker Section -->
      <section id="reps" class="section">
        <h2>Rep Tracker</h2>
        <div class="two-column">
          <div>
            <form method="POST">
              <div class="form-group">
                <label for="exercise-name">Exercise</label>
                <input type="text" id="exercise-name" name="exercise" value="{{ user.last_exercise_name or '' }}" placeholder="e.g., Push-ups" required aria-label="Exercise name" />
                <small>Enter the exercise name (e.g., Push-ups)</small>
              </div>
              <div class="form-group">
                <label for="reps-count">Reps</label>
                <input type="number" id="reps-count" name="reps" value="{{ user.last_reps or '' }}" placeholder="e.g., 12" min="0" required aria-label="Number of reps" />
                <small>How many repetitions per set?</small>
              </div>
              <div class="form-group">
                <label for="sets-count">Sets</label>
                <input type="number" id="sets-count" name="sets" value="{{ user.last_sets or '' }}" placeholder="e.g., 3" min="0" required aria-label="Number of sets" />
                <small>How many sets?</small>
              </div>
              <button type="submit" name="exercise_submit">Log Exercise üèãÔ∏è</button>
            </form>
          </div>
          <div>
            <h3 style="color: var(--accent); margin-bottom: 1rem;">Recent Exercise Log</h3>
            <ul id="reps-log">
              {% for log in exercise_logs %}
                <li>{{ log.exercise_name }}: {{ log.sets }} sets √ó {{ log.reps }} reps = {{ log.total_reps }} total reps</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </section>

      <!-- Meals Section -->
      <section id="meals" class="section">
        <h2>Meal Tracker</h2>
        <div class="two-column">
          <div>
            <form method="POST">
              <div class="form-group">
                <label for="meal">Meal Description</label>
                <textarea id="meal" name="meal" placeholder="e.g., Grilled chicken, rice &amp; veggies" rows="4" required aria-label="Meal description">{{ user.last_meal_description or '' }}</textarea>
                <small>Example: ‚ÄúGrilled chicken, rice &amp; veggies‚Äù</small>
              </div>
              <button type="submit" name="meal_submit">Log Meal üç¥</button>
            </form>
            <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--accent);">
            <!-- AI Meal Plan Generator -->
            <div class="form-group">
              <label for="meal-goal">AI Meal Plan Generator</label>
              <input type="text" id="meal-goal" placeholder="e.g., high protein, weight loss" aria-label="Meal goal or preference" style="margin-bottom: 8px;" />
              <button type="button" onclick="generateMeals()">Generate Meals with Nutrition ü§ñ</button>
            </div>
            <div class="result" id="meal-output" style="margin-top: 1rem;">Your AI meal plan will appear here.</div>
          </div>
          <div>
            <h3 style="color: var(--accent); margin-bottom: 1rem;">Today's Meals</h3>
            <ul id="meal-log">
              {% for log in meal_logs %}
                <li><strong>{{ log.timestamp.strftime('%Y-%m-%d %H:%M') }}:</strong> {{ log.meal_description }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </section>

      <!-- Weight Goals Section -->
      <section id="goals" class="section">
        <h2>Weight Goals Tracker</h2>
        <div class="two-column">
          <div>
            <form method="POST">
              <div class="form-group">
                <label for="current-weight">Current Weight (kg)</label>
                <input type="number" id="current-weight" name="current_weight" value="{{ user.current_weight or '' }}" placeholder="e.g., 80.0" min="0" step="0.1" required aria-label="Current weight in kilograms" />
                <small>Use decimal format (e.g., 80.0)</small>
              </div>
              <div class="form-group">
                <label for="goal-weight">Goal Weight (kg)</label>
                <input type="number" id="goal-weight" name="goal_weight" value="{{ user.goal_weight or '' }}" placeholder="e.g., 75.0" min="0" step="0.1" required aria-label="Goal weight in kilograms" />
                <small>Use decimal format (e.g., 75.0)</small>
              </div>
              <button type="submit" name="goal_submit">Save Goal üéØ</button>
            </form>
          </div>
          <div>
            <div class="result" id="goal-result" style="margin-top: 1rem;">
              {% if user.goal_weight and user.current_weight %}
                Your goal is <strong>{{ user.goal_weight }} kg</strong>. You are currently <strong>{{ user.current_weight }} kg</strong>.
              {% else %}
                Set your current and goal weight to track progress.
              {% endif %}
            </div>
          </div>
        </div>
      </section>

      <!-- Workout Plan Section -->
      <section id="workout" class="section">
        <h2>Weekly Workout Plan</h2>
        <div class="form-group">
          <label for="workout-day">Select Day</label>
          <select id="workout-day" name="workout-day" onchange="displayWorkoutForDay()" aria-label="Select workout day">
            <option value="" disabled selected>Select a day</option>
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
          </select>
        </div>
        <div style="margin: 1rem 0;">
          <button type="button" onclick="togglePlanSource()" id="toggle-plan-btn">Switch to AI Plan ü§ñ</button>
        </div>
        <div class="result" id="plan-output">Select a day to view your workout plan</div>
        <div id="ai-plan-block" style="margin-top: 1.5rem; display: none;">
          <label for="ai-goal">Enter your fitness goal:</label>
          <input type="text" id="ai-goal" placeholder="e.g., build muscle, lose fat, etc." style="width: 100%; padding: 10px; margin-top: 8px;" />
          <button onclick="generateAIWorkout()" style="margin-top: 10px;">Create AI Workout Plan ü§ñ</button>
          <div class="result" id="ai-workout-output" style="margin-top: 1rem;">Your AI-powered plan will appear here.</div>
        </div>
      </section>

      <!-- Water Tracker Section -->
      <section id="water" class="section">
        <h2>Water Intake Tracker</h2>
        <div class="two-column">
          <div>
            <form method="POST" onsubmit="event.preventDefault(); logWater();">
              <div class="form-group">
                <label for="water-intake">Cups of Water Today</label>
                <input type="number" id="water-intake" name="cups" placeholder="e.g., 1 cup = 250ml" min="0" required aria-label="Cups of water today" />
                <small>1 cup ‚âà 250ml. Log every drink!</small>
              </div>
              <button type="submit">Log Water üíß</button>
            </form>
            <div class="result" style="margin-top: 1rem;" id="hydration-tips">
              üí° Tip: Most adults need around 8‚Äì10 cups of water per day. Adjust based on your activity level!
            </div>
          </div>
          <div>
            <div class="result" id="water-result" style="margin-top: 1rem;">
              <h3 style="color: var(--accent); margin-bottom: 1rem;">Today's Water Log</h3>
              <ul id="water-log"></ul>
              <div id="hydration-status" style="margin-top: 1rem;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Progress Chart Section -->
      <section id="progress" class="section">
        <h2>Progress Chart</h2>
        <div class="form-group">
          <label for="progress-range">Time Range</label>
          <select id="progress-range" onchange="updateProgressChart()">
            <option value="week">This Week</option>
            <option value="month">This Month</option>
          </select>
        </div>
        <div class="two-column">
          <div>
            <canvas id="progressChart" width="400" height="300"></canvas>
            <div class="result" style="background: #0d1b2a; color: #00e0ff; border-left: 4px solid #00e0ff;">
              <strong>Performance Summary:</strong><br />
              You've increased reps by 150 since Week 1!<br />
              You've lost 3 kg ‚Äì great job!
            </div>
            <div style="margin-top: 1rem; color: var(--text); font-weight: bold;">üèãÔ∏è Reps today: 0</div>
            <!-- Nutrition Summary Block -->
            <div class="card" style="margin-top: 1rem;">
              <h2 style="margin-bottom: 0.5rem;">üçΩÔ∏è Daily Nutrition Summary</h2>
              <div id="nutrition-summary" style="font-family: monospace; line-height: 1.6;">
                <p><strong>Calories:</strong> 2200 kcal</p>
                <p><strong>Protein:</strong> 150g</p>
                <p><strong>Carbs:</strong> 180g</p>
                <p><strong>Fats:</strong> 70g</p>
                <p style="font-size: 0.85rem; color: gray;">(Sample totals ‚Äì update based on meal logs)</p>
              </div>
            </div>
            <!-- End Nutrition Summary Block -->
          </div>
          <div>
            <canvas id="nutritionChart" width="400" height="300"></canvas>
          </div>
        </div>
      </section>

      <!-- About Section -->
      <section id="about" class="section">
        <h2>About FITZONE</h2>
        <p style="line-height:1.6;">Fitzone is your AI-powered training dashboard. Track your workouts, monitor BMI and calories, log meals and hydration, and focus on targeted muscle development. Designed with best practices in fitness tech.</p>
        <p style="margin-top:20px;">Inspired by: MyFitnessPal, Strong App, Fitbod.</p>
      </section>

      <!-- <form action="{{ url_for('logout') }}">
        <button type="submit" style="background-color: #d63031; color: #fff;">Logout</button>
      </form> -->
    </div>
  </main>

  <script>
    // IMPORTANT: This app uses the OpenAI API. API keys are not included in this public version.
    // Replace 'YOUR_OPENAI_API_KEY_HERE' with your actual OpenAI API key when running locally.
    // Load saved theme on page load before anything else
    (function() {
      const savedTheme = localStorage.getItem('fitzone-theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
      }
    })();

    function toggleTheme() {
      document.body.classList.toggle('light-mode');
      const theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
      localStorage.setItem('fitzone-theme', theme);
    }

    // Navigation functionality
    function showSection(sectionId) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });

      // Remove active class from all nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });

      // Show selected section
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.add('active');
      } else {
        console.error(`Section with ID ${sectionId} not found`);
        return;
      }

      // Add active class to clicked nav item
      const navItem = event.target.closest('.nav-item');
      if (navItem) {
        navItem.classList.add('active');
      }

      // Initialize specific sections
      try {
        if (sectionId === 'progress' && !chart) {
          initProgressChart();
        } else if (sectionId === 'workout') {
          showPlan();
        }
      } catch (error) {
        console.error(`Error initializing section ${sectionId}:`, error);
      }
    }

    // BMI Calculator
    function calculateBMI() {
      const w = parseFloat(document.getElementById('weight').value);
      const h = parseFloat(document.getElementById('height').value) / 100;
      const resultDiv = document.getElementById('bmi-result');
      
      if (!w || !h || w <= 0 || h <= 0) {
        resultDiv.textContent = 'Please enter valid weight and height values';
        return;
      }
      
      const bmi = (w / (h * h)).toFixed(2);
      let status = bmi < 18.5 ? 'Underweight' :
                   bmi < 25 ? 'Normal Weight' :
                   bmi < 30 ? 'Overweight' : 'Obese';
      let color = bmi < 18.5 ? '#ff6b6b' :
                  bmi < 25 ? '#51cf66' :
                  bmi < 30 ? '#ffd43b' : '#ff6b6b';
      
      resultDiv.innerHTML = `
        <div style="color: ${color};">Your BMI is <strong>${bmi}</strong></div>
        <div>Category: <strong>${status}</strong></div>
      `;
    }

    // Calorie Calculator
    function calculateCalories() {
      const age = parseFloat(document.getElementById('cal-age').value);
      const w = parseFloat(document.getElementById('cal-weight').value);
      const h = parseFloat(document.getElementById('cal-height').value);
      const act = parseFloat(document.getElementById('cal-activity').value);
      const resultDiv = document.getElementById('cal-result');
      
      if (!age || !w || !h || age <= 0 || w <= 0 || h <= 0) {
        resultDiv.textContent = 'Please enter valid age, weight, and height';
        return;
      }
      
      const bmr = 10 * w + 6.25 * h - 5 * age + 5;
      const tdee = Math.round(bmr * act);
      const goal = tdee > 2500 ? 'Consider cutting calories for weight loss' :
                   tdee < 2000 ? 'Consider increasing calories for weight gain' :
                   'Maintain current intake for weight maintenance';
      
      resultDiv.innerHTML = `
        <div>Daily Calories (TDEE): <strong>${tdee} kcal</strong></div>
        <div style="margin-top: 10px;">${goal}</div>
      `;
    }

    // Progress Chart Variables
    const labels = [], repsArr = [], weightArr = [];
    let chart;

    function initProgressChart() {
      const canvas = document.getElementById('progressChart');
      if (!canvas || chart) return;

      const ctx = canvas.getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
          datasets: [
            {
              label: 'üèãÔ∏è Exercise',
              data: [100, 150, 180, 230],
              borderColor: '#00b4d8',
              backgroundColor: 'rgba(0,180,216,0.1)',
              tension: 0.3,
              fill: true,
              pointBackgroundColor: '#fff',
              pointRadius: 6
            },
            {
              label: '‚öñÔ∏è Weight',
              data: [80, 77, 77, 76],
              borderColor: '#ef476f',
              backgroundColor: 'rgba(239,71,111,0.1)',
              tension: 0.3,
              fill: true,
              pointBackgroundColor: '#fff',
              pointRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#fff' } },
            title: {
              display: true,
              text: 'Progress Overview (Exercise vs Weight)',
              color: '#00e0ff'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            x: {
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            }
          }
        }
      });

      const nutCtx = document.getElementById('nutritionChart').getContext('2d');
      new Chart(nutCtx, {
        type: 'doughnut',
        data: {
          labels: ['Protein', 'Carbs', 'Fats'],
          datasets: [{
            label: 'Nutrition Breakdown',
            data: [30, 40, 30],
            backgroundColor: ['#48cae4', '#80ed99', '#ffb703'],
            borderWidth: 2
          }]
        },
        options: {
          plugins: {
            legend: {
              labels: { color: '#fff' }
            },
            title: {
              display: true,
              text: 'Nutrition Breakdown',
              color: '#ffffff'
            }
          }
        }
      });
    }

    // Progress Chart Range Switcher
    function updateProgressChart() {
      const range = document.getElementById('progress-range').value;
      if (chart) {
        if (range === 'month') {
          chart.data.labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
          chart.data.datasets[0].data = [100, 140, 160, 190];
          chart.data.datasets[1].data = [80, 79, 77.5, 76];
        } else {
          chart.data.labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
          chart.data.datasets[0].data = [20, 25, 30, 35, 40];
          chart.data.datasets[1].data = [78.5, 78.4, 78.3, 78.2, 78.0];
        }
        chart.update();
      }
    }

    // Rep Tracker
    function logReps() {
      const ex = document.getElementById('exercise-name').value.trim();
      const r = parseInt(document.getElementById('reps-count').value);
      const s = parseInt(document.getElementById('sets-count').value);
      
      if (!ex || !r || !s || r <= 0 || s <= 0) {
        alert('Please enter a valid exercise name and positive numbers for reps and sets');
        return;
      }
      
      document.getElementById('reps-log').innerHTML += `<li>${ex}: ${s} sets √ó ${r} reps = ${s * r} total reps</li>`;
      labels.push(ex);
      repsArr.push(r * s);
      weightArr.push(null);
      if (chart) chart.update();
      
      document.getElementById('exercise-name').value = '';
      document.getElementById('reps-count').value = '';
      document.getElementById('sets-count').value = '';
    }

    // Meal Tracker
    function logMeal() {
      const meal = document.getElementById('meal').value.trim();
      if (!meal) {
        alert('Please enter a meal description');
        return;
      }
      
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      document.getElementById('meal-log').innerHTML += `<li><strong>${time}</strong>: ${meal}</li>`;
      document.getElementById('meal').value = '';
    }

    // Weight Goals
    function checkGoal() {
      const current = parseFloat(document.getElementById('current-weight').value);
      const goal = parseFloat(document.getElementById('goal-weight').value);
      const resultDiv = document.getElementById('goal-result');
      
      if (!current || !goal || current <= 0 || goal <= 0) {
        resultDiv.textContent = 'Please enter valid current and goal weights';
        return;
      }
      
      const diff = Math.abs(current - goal);
      const msg = current > goal ?
        `You need to lose ${diff.toFixed(1)} kg to reach your goal` :
        current < goal ?
        `You need to gain ${diff.toFixed(1)} kg to reach your goal` :
        'Congratulations! You\'re at your goal weight!';
      
      resultDiv.innerHTML = `
        <div><strong>${msg}</strong></div>
        <div style="margin-top: 10px;">Current: ${current} kg | Goal: ${goal} kg</div>
      `;
      
      labels.push('Weight Goal');
      repsArr.push(null);
      weightArr.push(goal);
      if (chart) chart.update();
    }

    // Workout Plans
    // Future Feature Ideas:
    // - Sync with wearable data
    // - AI-generated training plans
    // - Community leaderboard integration
    // - Dynamic progress prediction with ML

    // --- Workout Plan Toggle and Display Logic ---
    const defaultPlans = {
      Monday: 'Push Day: Bench Press, Shoulder Press, Tricep Dips. üèãÔ∏è‚Äç‚ôÇÔ∏è Focus: Strength<br>Suggested Rest: 1 min between sets<br>Tags: <span style="color:#00ff99;">Strength</span>',
      Tuesday: 'Pull Day: Deadlifts, Pull-ups, Barbell Rows, Bicep Curls. üèãÔ∏è‚Äç‚ôÇÔ∏è Focus: Strength<br>Suggested Rest: 90 sec<br>Tags: <span style="color:#00ff99;">Strength</span>',
      Wednesday: 'Leg Day: Squats, Lunges, Calf Raises, Leg Press. üèÉ‚Äç‚ôÇÔ∏è Focus: Strength & Mobility<br>Suggested Rest: 2 min<br>Tags: <span style="color:#00ff99;">Strength</span>, <span style="color:#ffd43b;">Mobility</span>',
      Thursday: 'HIIT & Core: Burpees, Mountain Climbers, Planks, Russian Twists. üèÉ‚Äç‚ôÇÔ∏è Focus: Cardio<br>Suggested Rest: 30 sec<br>Tags: <span style="color:#2196f3;">Cardio</span>, <span style="color:#ffd43b;">Mobility</span>',
      Friday: 'Full Body: Kettlebell Swings, Jump Squats, Battle Ropes, Thrusters. üí™ Focus: Strength & Cardio<br>Suggested Rest: 1 min<br>Tags: <span style="color:#00ff99;">Strength</span>, <span style="color:#2196f3;">Cardio</span>'
    };
    let useAIPlan = false;
    let aiPlanCache = {};

    function togglePlanSource() {
      useAIPlan = !useAIPlan;
      document.getElementById('toggle-plan-btn').textContent = useAIPlan ? 'Switch to Default Plan üìù' : 'Switch to AI Plan ü§ñ';
      document.getElementById('ai-plan-block').style.display = useAIPlan ? 'block' : 'none';
      displayWorkoutForDay();
    }

    function displayWorkoutForDay() {
      const daySelect = document.getElementById('workout-day');
      const day = daySelect ? daySelect.value : '';
      const planOutput = document.getElementById('plan-output');
      if (!day) {
        planOutput.textContent = 'Select a day to view your workout plan';
        return;
      }
      if (useAIPlan) {
        if (aiPlanCache[day]) {
          planOutput.innerHTML = `<div><strong>${day} (AI Plan):</strong></div><div style="margin-top: 10px;">${aiPlanCache[day]}</div>`;
        } else {
          planOutput.innerHTML = `<div><strong>${day} (AI Plan):</strong></div><div style="margin-top: 10px; color:#aaa;">No AI plan generated for this day yet. Enter your goal and generate one below.</div>`;
        }
      } else {
        if (defaultPlans[day]) {
          planOutput.innerHTML = `<div><strong>${day} Workout:</strong></div><div style="margin-top: 10px;">${defaultPlans[day]}</div>`;
        } else {
          planOutput.textContent = 'No workout plan available for this day';
        }
      }
    }

    // AI Workout Plan Generator
    async function generateAIWorkout() {
      const goal = document.getElementById('ai-goal').value.trim();
      const output = document.getElementById('ai-workout-output');
      const daySelect = document.getElementById('workout-day');
      // Read the selected day value directly from the select
      const day = daySelect ? daySelect.value : '';
      // Debug log for day and goal
      console.log("Generating plan for:", day, "Goal:", goal);
      output.innerHTML = ''; // Clear any old messages
      if (!goal) {
        output.textContent = 'Please enter a fitness goal.';
        return;
      }
      if (!day) {
        output.textContent = 'Please select a day above to generate an AI plan for.';
        return;
      }
      output.textContent = 'Generating workout...';

      try {
        // IMPORTANT: No API key is provided in this public version.
        // Replace 'YOUR_OPENAI_API_KEY_HERE' with your actual OpenAI API key before running locally.
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer YOUR_OPENAI_API_KEY_HERE" // <-- Replace locally before running
          },
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: [
              {
                role: "system",
                content: "You are a certified fitness trainer. Generate a full workout plan based on the user's fitness goal."
              },
              {
                role: "user",
                content: `Create a workout plan for ${day} to help me: ${goal}`
              }
            ]
          })
        });

        const data = await response.json();
        let planText = "No AI plan available.";
        if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
          planText = data.choices[0].message.content;
        } else {
          output.textContent = 'AI did not return a valid plan. Please try again or check your API key.';
          console.warn('AI response missing expected keys:', data);
          return;
        }
        output.innerHTML = `<pre style="white-space: pre-wrap;">${planText}</pre>`;
        aiPlanCache[day] = planText;
        displayWorkoutForDay();
        // Send the generated workout to the Flask backend
        await fetch("/save_ai_workout", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ workout_plan: planText })
        });
      } catch (error) {
        output.textContent = 'Error generating workout plan. Please check your network connection or API key and try again.';
        console.error(error);
      }
    }

    // Water Tracker
    function logWater() {
      const cupsInput = document.getElementById('water-intake');
      const cups = parseInt(cupsInput.value);
      const logList = document.getElementById('water-log');
      const statusDiv = document.getElementById('hydration-status');

      if (isNaN(cups) || cups <= 0) {
        statusDiv.innerHTML = `<div style="color: #ff6b6b;">‚ùå Please enter a valid number of cups</div>`;
        return;
      }

      const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const entry = document.createElement('li');
      entry.innerHTML = `<strong>${timeStr}</strong>: ${cups} cup${cups > 1 ? 's' : ''}`;
      logList.appendChild(entry);

      let total = 0;
      for (const li of logList.children) {
        const match = li.textContent.match(/(\d+)\s+cup/);
        if (match) total += parseInt(match[1]);
      }

      const percentage = Math.min((total / 8) * 100, 100);
      let statusMsg = '';
      if (total >= 8) {
        statusMsg = '‚úÖ Hydration Goal Met! üíß Keep it up!';
      } else if (total >= 6) {
        statusMsg = 'üü° Almost there! Just a little more.';
      } else {
        statusMsg = 'üî¥ Low intake. Drink more water!';
      }

      statusDiv.innerHTML = `
        <div><strong>Total Water: ${total} cups</strong></div>
        <div>Progress: ${percentage.toFixed(1)}%</div>
        <div>${statusMsg}</div>
      `;

      cupsInput.value = '';
    }


    // Initialize workout plan UI on page load
    document.addEventListener('DOMContentLoaded', function() {
      const hash = window.location.hash.substring(1);
      if (hash) {
        const navItem = document.querySelector(`.nav-item[onclick="showSection('${hash}')"]`);
        if (navItem) {
          navItem.click();
        }
      }
      displayWorkoutForDay();
    });
  </script>
</body>
</html>

<!-- Forms Section (for saving/logging data and logout)
... (intentionally left commented out) ...
-->
  <script>
    // ...existing code above...

    // AI Meal Plan Generator with Macronutrient Details
    function generateMeals() {
      const goal = document.getElementById("meal-goal").value.trim();
      if (!goal) {
        alert("Please enter a goal or preference (e.g., high protein, weight loss).");
        return;
      }

      const output = document.getElementById("meal-output");
      output.textContent = "Generating meals with nutritional breakdown...";

      // IMPORTANT: No API key is provided in this public version.
      // Replace 'YOUR_OPENAI_API_KEY_HERE' with your actual OpenAI API key before running locally.
      fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer YOUR_OPENAI_API_KEY_HERE" // <-- Replace locally before running
        },
        body: JSON.stringify({
          model: "gpt-4",
          messages: [
            {
              role: "system",
              content: "You are a nutrition assistant who generates daily meal plans and includes detailed macronutrient information per meal. Return all meals clearly formatted.",
            },
            {
              role: "user",
              content: `Create a daily meal plan for this fitness goal: ${goal}. Include total calories and grams of carbs, protein, and fat per meal.`,
            },
          ],
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          const response = data.choices[0].message.content;
          output.innerHTML = `<pre style="white-space: pre-wrap; background:#1e1e1e; color:#fff; padding:1rem; border-radius:8px;">${response}</pre>`;

          // Extract macros from the response
          const caloriesMatch = response.match(/Calories:\s*(\d+)/i);
          const proteinMatch = response.match(/Protein:\s*(\d+)/i);
          const carbsMatch = response.match(/Carbs:\s*(\d+)/i);
          const fatsMatch = response.match(/Fats?:\s*(\d+)/i);

          if (caloriesMatch && proteinMatch && carbsMatch && fatsMatch) {
            const nutritionData = {
              calories: parseInt(caloriesMatch[1]),
              protein: parseInt(proteinMatch[1]),
              carbs: parseInt(carbsMatch[1]),
              fats: parseInt(fatsMatch[1])
            };

            // Save nutrition to server
            fetch("/save_nutrition", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(nutritionData)
            })
            .then(() => {
              // After saving nutrition, fetch and update the daily nutrition summary
              fetch("/get_nutrition_summary")
                .then((res) => res.json())
                .then((summary) => {
                  const ns = document.getElementById("nutrition-summary");
                  ns.innerHTML = `
                    <p><strong>Calories:</strong> ${summary.calories} kcal</p>
                    <p><strong>Protein:</strong> ${summary.protein}g</p>
                    <p><strong>Carbs:</strong> ${summary.carbs}g</p>
                    <p><strong>Fats:</strong> ${summary.fats}g</p>
                    <p style="font-size: 0.85rem; color: gray;">Updated via AI meal plan</p>
                  `;
                });
            });
          }
        })
        .catch((err) => {
          output.textContent = "Error generating meals. Please try again.";
          console.error(err);
        });
    }
  </script>